<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Donut - 온라인 주문</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* 기본 스타일 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            background-image: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        /* 헤더 스타일 개선 - Jainery 스타일 */
        .header {
            background: #fff;
            padding: 4rem 0 3rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -20%;
            right: -15%;
            width: 500px;
            height: 500px;
            background: linear-gradient(45deg, rgba(255, 71, 87, 0.08), rgba(255, 71, 87, 0.15));
            border-radius: 50%;
            z-index: 0;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -15%;
            width: 400px;
            height: 400px; 
            background: linear-gradient(45deg, rgba(255, 71, 87, 0.08), rgba(255, 71, 87, 0.15));
            border-radius: 50%;
            z-index: 0;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
            color: #ff4757;
            position: relative;
            display: inline-block;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        .header-divider {
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, #ff4757, #ff6b6b);
            margin: 1rem auto 1.5rem;
            border-radius: 3px;
        }

        /* 메인 컨테이너 스타일 - Jainery 스타일 */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem 4rem;
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 15%;
            right: 5%;
            width: 200px;
            height: 200px;
            background: linear-gradient(45deg, rgba(255, 71, 87, 0.03), rgba(255, 71, 87, 0.08));
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            z-index: -1;
        }

        .container::after {
            content: '';
            position: absolute;
            bottom: 10%;
            left: 5%;
            width: 250px;
            height: 250px;
            background: linear-gradient(45deg, rgba(255, 71, 87, 0.03), rgba(255, 71, 87, 0.08));
            border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;
            z-index: -1;
        }

        /* 카테고리 탭 스타일 - Jainery 스타일 */
        .category-tabs {
            display: flex;
            justify-content: center;
            margin: 3rem auto 2.5rem;
            max-width: 800px;
            padding: 0.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }

        .category-tab {
            background: none;
            border: none;
            padding: 1rem 1.8rem;
            margin: 0 0.3rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #555;
            position: relative;
            font-weight: 500;
            border-radius: 8px;
        }

        .category-tab.active {
            color: #fff;
            background: #ff4757;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.25);
        }

        .category-tab:not(.active):hover {
            background-color: #f5f5f5;
            color: #ff4757;
        }

        /* 카테고리 콘텐츠 스타일 */
        .category-content {
            display: none !important;
        }

        .category-content.active {
            display: grid !important;
        }

        /* 메뉴 그리드 - Jainery 스타일 */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 2.5rem;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* 섹션 타이틀 스타일 */
        .section-title {
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }

        .section-title h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 1rem;
        }

        .section-title p {
            font-size: 1.1rem;
            color: #666;
            max-width: 600px;
            margin: 0 auto;
        }

        /* 메뉴 아이템 카드 디자인 - Jainery 스타일 */
        .menu-item {
            display: block;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.4s ease;
            padding: 2rem;
            position: relative;
            border: none;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }

        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 0;
            background: linear-gradient(to bottom, #ff4757, #ff6b6b);
            transition: height 0.5s ease;
            border-radius: 0 0 4px 0;
        }

        .menu-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.09);
        }

        .menu-item:hover::before {
            height: 50%;
        }

        .menu-item img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 12px;
            margin-right: 1.5rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.4s ease;
        }

        .menu-item:hover img {
            transform: scale(1.05);
            box-shadow: 0 12px 25px rgba(255, 71, 87, 0.15);
        }

        .menu-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .menu-item-content {
            flex: 1;
        }

        .menu-item h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
            color: #333;
            transition: all 0.3s ease;
            position: relative;
            display: inline-block;
        }

        .menu-item:hover h3 {
            color: #ff4757;
        }

        .menu-item p {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 1rem;
            line-height: 1.7;
        }

        .menu-item .price-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            position: relative;
        }

        .menu-item .price-container::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(to right, rgba(0,0,0,0.05), rgba(0,0,0,0.1), rgba(0,0,0,0.05));
        }

        .menu-item .price {
            font-size: 1.4rem;
            font-weight: 700;
            color: #ff4757;
            padding: 0.5rem 1rem;
            position: relative;
        }

        .add-to-cart {
            background: #ff4757;
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(255, 71, 87, 0.25);
            position: relative;
            overflow: hidden;
        }

        .add-to-cart::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.3), rgba(255,255,255,0));
            transition: all 0.4s ease;
        }

        .add-to-cart:hover {
            background: #ff2d41;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 71, 87, 0.4);
        }

        .add-to-cart:hover::before {
            left: 100%;
        }

        .veg-indicator {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 1px solid red;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .veg-indicator::after {
            content: '';
            width: 12px;
            height: 12px;
            background-color: red;
            border-radius: 50%;
        }

        /* 장바구니 아이콘 - Jainery 스타일 */
        .cart-icon {
            position: fixed;
            top: 25px;
            right: 25px;
            background: #fff;
            color: #ff4757;
            border: none;
            width: 52px;
            height: 52px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .cart-icon:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            color: #ff2d41;
        }

        .cart-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4757;
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        /* 장바구니 모달 */
        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .cart-modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .cart-content {
            background: white;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 480px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.4s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #f1f1f1;
        }

        .cart-header h2 {
            color: #333;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin: 0;
        }

        .cart-header h2 i {
            color: #ff4757;
        }

        .close-cart {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
            transition: color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
        }

        .close-cart:hover {
            color: #ff4757;
            background-color: #f5f5f5;
        }

        .cart-items {
            padding: 1.5rem 2rem;
            overflow-y: auto;
            flex: 1;
            max-height: 50vh;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.8rem;
            transition: all 0.3s ease;
            border-radius: 10px;
            background-color: #f9f9f9;
        }

        .cart-item:hover {
            background-color: #f2f2f2;
            transform: translateX(5px);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 0.3rem;
            color: #333;
        }

        .cart-item-price {
            color: #666;
            font-size: 0.9rem;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.6rem;
        }

        .quantity-btn {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #555;
        }

        .quantity-btn:hover {
            background: #ff4757;
            color: white;
            border-color: #ff4757;
        }

        .cart-footer {
            padding: 1.5rem 2rem;
            background-color: #f9f9f9;
            border-top: 1px solid #f1f1f1;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            font-size: 1.2rem;
        }

        .cart-total-label {
            font-weight: 600;
            color: #333;
        }

        .cart-total-amount {
            font-weight: 700;
            color: #ff4757;
        }

        .checkout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 1rem 0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            width: 100%;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.2);
        }

        .checkout-btn:hover {
            background: #ff2d41;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.3);
        }

        .empty-cart-message {
            text-align: center;
            padding: 3rem 2rem;
            color: #888;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .empty-cart-message .material-icons {
            font-size: 3rem;
            color: #ddd;
        }

        .empty-cart-message p {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
        }

        /* 주문 모달 - Jainery 스타일 */
        .order-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .order-modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .order-content {
            background: white;
            padding: 0;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.4s ease;
        }

        .order-form {
            padding: 1.5rem 2rem 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            overflow-y: auto;
            max-height: 60vh;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            font-size: 0.95rem;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.9rem 1rem;
            border: 1px solid #eee;
            border-radius: 10px;
            font-size: 1rem;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            width: 100%;
            font-family: 'Poppins', 'Noto Sans KR', sans-serif;
        }

        .form-group textarea {
            resize: none;
            line-height: 1.5;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff4757;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(255, 71, 87, 0.1);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #aaa;
        }

        .submit-order {
            background: #ff4757;
            color: white;
            border: none;
            padding: 1rem 0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 1rem;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 71, 87, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .submit-order:hover {
            background: #ff2d41;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.3);
        }

        .submit-order .material-icons {
            font-size: 1.3rem;
        }

        /* 로딩 오버레이 */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes addToCartSuccess {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .add-success {
            animation: addToCartSuccess 0.5s ease;
        }

        /* 카드 디자인 추가 개선 */
        .menu-item {
            display: block;
            background: white;
            border: 1px dashed #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            padding: 2rem;
            position: relative;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        /* 메뉴 아이템이 없을 때 스타일 */
        .no-items-message {
            text-align: center;
            padding: 3rem;
            color: #888;
            font-size: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px dashed #ddd;
            margin: 2rem auto;
            max-width: 500px;
        }

        /* 모바일 반응형 디자인 - Jainery 스타일 */
        @media (max-width: 768px) {
            .header {
                padding: 3rem 0 2rem;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .header p {
                font-size: 1rem;
                padding: 0 1rem;
            }
            
            .container {
                padding: 0 1.5rem 3rem;
            }
            
            .section-title h2 {
                font-size: 1.8rem;
            }
            
            .section-title p {
                font-size: 1rem;
                padding: 0 1rem;
            }
            
            .category-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                justify-content: flex-start;
                padding: 0.5rem;
                margin: 2rem 0;
            }
            
            .category-tab {
                white-space: nowrap;
                flex-shrink: 0;
                padding: 0.8rem 1.5rem;
                font-size: 0.9rem;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
            
            .menu-item {
                padding: 1.5rem;
            }
            
            .menu-item-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            
            .menu-item img {
                margin-right: 0;
                margin-bottom: 1.5rem;
            }
            
            .menu-item-content {
                text-align: center;
            }
            
            .menu-item .price-container {
                flex-direction: column;
                gap: 1rem;
            }
            
            .cart-content, 
            .order-content {
                width: 95%;
            }
        }

        @media (min-width: 769px) and (max-width: 1100px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- 헤더 -->
    <header class="header">
        <div class="header-content">
            <h1>Delicious Menus</h1>
            <div class="header-divider"></div>
            <p>Discover our handcrafted selection of premium dishes made with the finest ingredients</p>
        </div>
    </header>

    <!-- 메인 컨텐츠 -->
    <main class="container">
        <!-- 섹션 타이틀 -->
        <div class="section-title">
            <h2>Our Menu</h2>
            <p>Browse our selection of delicious dishes prepared with fresh ingredients</p>
        </div>
        
        <!-- 카테고리 탭 -->
        <div class="category-tabs">
            <!-- 탭은 동적으로 생성됩니다 -->
        </div>

        <!-- 카테고리 콘텐츠도 동적으로 생성됩니다 -->
    </main>

    <!-- 장바구니 아이콘 -->
    <button class="cart-icon" onclick="toggleCart()">
        <span class="material-icons">shopping_cart</span>
        <span class="cart-badge" id="cartCount">0</span>
    </button>

    <!-- 장바구니 모달 -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-content">
            <div class="cart-header">
                <h2><i class="material-icons">shopping_cart</i> Your Cart</h2>
                <button class="close-cart" onclick="toggleCart()"><i class="material-icons">close</i></button>
            </div>
            <div id="cartItems" class="cart-items">
                <!-- 장바구니 아이템들이 여기에 동적으로 추가됩니다 -->
            </div>
            <div class="cart-footer">
                <div class="cart-total">
                    <span class="cart-total-label">Total</span>
                    <span class="cart-total-amount">$ <span id="cartTotal">0</span> USD</span>
                </div>
                <button class="checkout-btn" onclick="showOrderForm()">
                    <i class="material-icons">shopping_bag</i> Proceed to Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- 주문 모달 -->
    <div class="order-modal" id="orderModal">
        <div class="order-content">
            <div class="cart-header">
                <h2><i class="material-icons">assignment</i> Order Information</h2>
                <button class="close-cart" onclick="closeOrderForm()"><i class="material-icons">close</i></button>
            </div>
            <form class="order-form" id="orderForm">
                <div class="form-group">
                    <label for="name">Full Name</label>
                    <input type="text" id="name" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="tel" id="phone" placeholder="Enter your phone number" required>
                </div>
                <div class="form-group">
                    <label for="address">Delivery Address</label>
                    <input type="text" id="address" placeholder="Enter your address" required>
                </div>
                <div class="form-group">
                    <label for="deliveryOption">Delivery Option</label>
                    <select id="deliveryOption" required>
                        <option value="pickup">Pickup at Restaurant</option>
                        <option value="delivery">Home Delivery</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pickupTime">Preferred Time</label>
                    <input type="datetime-local" id="pickupTime" required>
                </div>
                <div class="form-group">
                    <label for="notes">Special Instructions (Optional)</label>
                    <textarea id="notes" rows="3" placeholder="Any special requests or notes for your order"></textarea>
                </div>
                <button type="submit" class="submit-order" onclick="submitOrder(event)">
                    <i class="material-icons">check_circle</i> Complete Order
                </button>
            </form>
        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Processing your order...</p>
        </div>
    </div>

    <script>
        // 장바구니 데이터
        let cart = [];
        
        // 구글 시트 API URL (기존 주문 처리 URL과 동일)
        const API_URL = 'https://script.google.com/macros/s/AKfycbzuIZT-pRiC4o53u0ruWefsfRqyDasNQqW7nOfs5ipHZ0PlicbFP3FixcjDZv4rha8QXQ/exec';
        const SHEET_ID = '1_3vfkReCDiWfQAIHwfC2vNPmJZk-EAhIO6AAsmrYms4';
        const REFRESH_INTERVAL = 5 * 60 * 1000; // 5분마다 메뉴 새로고침
        
        // 메뉴 데이터 가져오기
        async function fetchMenuData() {
            // 로딩 표시
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.querySelector('.loading-content p').textContent = '메뉴 불러오는 중...';
            
            try {
                // 1. JSONP를 통해 데이터 가져오기 시도
                try {
                    console.log('JSONP를 통한 메뉴 데이터 요청 시도...');
                    const menuDataFromJsonp = await fetchMenuDataJSONP();
                    
                    // JSONP 에러 확인
                    if (menuDataFromJsonp && menuDataFromJsonp._jsonpError) {
                        console.log('JSONP 사용 불가, 다른 방법으로 진행합니다.');
                    } else {
                        // 정상적인 JSONP 응답 처리
                        // 로딩 숨기기
                        setTimeout(() => {
                            document.getElementById('loadingOverlay').style.display = 'none';
                        }, 500);
                        
                        console.log('JSONP로부터 메뉴 데이터 성공적으로 로드됨');
                        return menuDataFromJsonp;
                    }
                } catch (jsonpError) {
                    console.warn('다른 데이터 접근 방식으로 전환합니다.', jsonpError.message);
                }
                
                // 2. 직접 이미지 URL 접근 시도
                try {
                    const directImageData = await fetchDirectImageUrls();
                    if (directImageData) {
                        // 로딩 숨기기
                        setTimeout(() => {
                            document.getElementById('loadingOverlay').style.display = 'none';
                        }, 500);
                        
                        console.log('직접 이미지 URL 접근 성공');
                        return directImageData;
                    }
                } catch (directError) {
                    console.warn('직접 이미지 URL 접근 실패:', directError.message);
                }
                
                console.warn('CSV 방식으로 시도합니다');
                
                // 3. CSV 방식으로 시도
                // Google Sheets CSV 형식으로 데이터 가져오기
                const response = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=메뉴 목록`);
                const csvText = await response.text();
                
                console.log('CSV 원본 데이터 샘플:', csvText.substring(0, 200));
                
                // CSV 파싱을 간소화하면서 큰따옴표 처리에 주의
                const rows = csvText.split('\n');
                const lines = [];
                
                for (let row of rows) {
                    // 빈 줄 무시
                    if (!row.trim()) continue;
                    
                    const fields = [];
                    let inQuote = false;
                    let field = '';
                    
                    for (let i = 0; i < row.length; i++) {
                        const char = row[i];
                        
                        if (char === '"') {
                            inQuote = !inQuote;
                        } else if (char === ',' && !inQuote) {
                            fields.push(field.replace(/^"|"$/g, ''));
                            field = '';
                        } else {
                            field += char;
                        }
                    }
                    
                    fields.push(field.replace(/^"|"$/g, ''));
                    lines.push(fields);
                }
                
                console.log('파싱된 CSV 데이터 샘플:', lines.slice(0, 2));
                
                const headers = lines[0].map(header => header.toLowerCase().trim());
                
                const categoryIndex = headers.indexOf('category');
                const nameIndex = headers.indexOf('name');
                const descriptionIndex = headers.indexOf('description');
                const priceIndex = headers.indexOf('price');
                const imageUrlIndex = headers.indexOf('imageurl');
                
                if (categoryIndex === -1 || nameIndex === -1 || priceIndex === -1) {
                    throw new Error('필수 열(category, name, price)이 없습니다.');
                }
                
                // 카테고리 동적으로 처리
                const menuData = {};
                
                // 데이터에서 고유 카테고리 추출
                const categories = new Set();
                
                // 데이터 행 처리 - 첫 번째 패스: 카테고리 수집
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i];
                    const category = row[categoryIndex]?.trim();
                    
                    if (category) {
                        categories.add(category);
                    }
                }
                
                // 발견된 모든 카테고리에 대한 객체 생성
                categories.forEach(category => {
                    menuData[category] = [];
                });
                
                // 기본 카테고리도 확인 (없으면 추가)
                if (!menuData['donut']) menuData['donut'] = [];
                if (!menuData['cake-donut']) menuData['cake-donut'] = [];
                if (!menuData['breakfast']) menuData['breakfast'] = [];
                
                console.log('발견된 카테고리:', Object.keys(menuData));
                
                // 데이터 행 처리 - 두 번째 패스: 메뉴 아이템 추가
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i];
                    const category = row[categoryIndex]?.trim();
                    const name = row[nameIndex]?.trim();
                    const price = parseFloat(row[priceIndex]);
                    
                    // 값 로깅
                    console.log(`행 ${i} 데이터: category=${category}, name=${name}, price=${price}, imageUrl=${row[imageUrlIndex]}`);
                    
                    if (!category || !name || isNaN(price)) continue;
                    
                    const menuItem = {
                        name: name,
                        price: price,
                        description: descriptionIndex !== -1 ? row[descriptionIndex]?.trim() || '' : '',
                        imageUrl: imageUrlIndex !== -1 ? row[imageUrlIndex]?.trim() || 'https://images.unsplash.com/photo-1551024506-0bccd828d307' : 'https://images.unsplash.com/photo-1551024506-0bccd828d307'
                    };
                    
                    // 이미지 URL 안전성 검증
                    if (menuItem.imageUrl) {
                        // 구글 드라이브 URL 변환 시도
                        if (menuItem.imageUrl.includes('drive.google.com/file/d/')) {
                            const convertedUrl = convertGoogleDriveUrl(menuItem.imageUrl);
                            if (convertedUrl) {
                                console.log('CSV 데이터에서 구글 드라이브 URL 변환:', menuItem.imageUrl, ' -> ', convertedUrl);
                                menuItem.imageUrl = convertedUrl;
                            }
                        }
                        
                        try {
                            // URL이 올바른 형식인지 확인
                            new URL(menuItem.imageUrl);
                            console.log('유효한 이미지 URL:', menuItem.imageUrl);
                        } catch (e) {
                            console.log('유효하지 않은 URL 형식:', menuItem.imageUrl);
                            menuItem.imageUrl = 'https://images.unsplash.com/photo-1551024506-0bccd828d307';
                        }
                    }
                    
                    if (menuData.hasOwnProperty(category)) {
                        menuData[category].push(menuItem);
                    }
                }
                
                // 로딩 숨기기
                setTimeout(() => {
                    document.getElementById('loadingOverlay').style.display = 'none';
                }, 500);
                
                return menuData;
            } catch (error) {
                // 모든 방법이 실패한 경우
                console.error('메뉴 데이터를 가져오는 중 오류가 발생했습니다:', error);
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // 기본 메뉴 데이터 반환
                return getDefaultMenuData();
            }
        }
        
        // 기본 메뉴 데이터 반환
        function getDefaultMenuData() {
            return {
                "donut": [
                    { name: "GLAZED", description: "도넛", price: 0.99, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" },
                    { name: "CHOCOLATE", description: "초코 도넛", price: 1.09, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" },
                    { name: "SPRINKLES", description: "스프링클 도넛", price: 1.09, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" },
                    { name: "TWIST", description: "트위스트 도넛", price: 1.79, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" },
                    { name: "ECLAIR", description: "에클레어 도넛", price: 1.99, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" }
                ],
                "cake-donut": [
                    { name: "PLAIN", description: "플레인 케이크 도넛", price: 1.39, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" },
                    { name: "BUTTERMILK", description: "버터밀크 케이크 도넛", price: 1.59, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" },
                    { name: "BLUEBERRY", description: "블루베리 케이크 도넛", price: 1.59, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" }
                ],
                "breakfast": [
                    { name: "SMALL SAUSAGE", description: "소시지 샌드위치", price: 1.59, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" },
                    { name: "JUMBO SAUSAGE", description: "점보 소시지 샌드위치", price: 2.99, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" },
                    { name: "CROISSANT HAM & CHEESE", description: "햄치즈 크루아상", price: 3.99, imageUrl: "https://images.unsplash.com/photo-1551024506-0bccd828d307" }
                ]
            };
        }

        // 주기적으로 메뉴 업데이트
        async function refreshMenu() {
            try {
                const menuData = await fetchMenuData();
                
                // 카테고리 순서 조정 - donut 카테고리를 맨 앞으로
                const orderedCategories = Object.keys(menuData);
                
                // donut 카테고리가 있으면 맨 앞으로 이동
                if (orderedCategories.includes('donut')) {
                    const donutIndex = orderedCategories.indexOf('donut');
                    orderedCategories.splice(donutIndex, 1); // donut 카테고리 제거
                    orderedCategories.unshift('donut'); // 맨 앞에 추가
                    
                    // 순서가 조정된 새 객체 생성
                    const orderedMenuData = {};
                    orderedCategories.forEach(category => {
                        orderedMenuData[category] = menuData[category];
                    });
                    
                    // 순서가 조정된 메뉴 데이터로 UI 업데이트
                    updateMenuUI(orderedMenuData);
                } else {
                    // donut 카테고리가 없으면 그대로 업데이트
                    updateMenuUI(menuData);
                }
                
                console.log('메뉴가 성공적으로 업데이트되었습니다.');
            } catch (error) {
                console.error('메뉴 업데이트 중 오류가 발생했습니다:', error);
                updateMenuUI(getDefaultMenuData());
            }
        }

        // 메뉴 데이터로 화면 업데이트
        function updateMenuUI(menuData) {
            if (!menuData) return; // 메뉴 데이터가 없으면 기존 메뉴 유지
            
            console.log('메뉴 데이터 업데이트:', Object.keys(menuData));
            
            // 동적 카테고리 탭 생성 또는 업데이트
            updateCategoryTabs(Object.keys(menuData));
            
            // 각 카테고리별 메뉴 업데이트
            Object.keys(menuData).forEach(category => {
                let categoryContainer = document.getElementById(category);
                
                // 해당 카테고리 컨테이너가 없으면 새로 생성
                if (!categoryContainer) {
                    // 메인 컨테이너 찾기
                    const mainContainer = document.querySelector('.container');
                    
                    // 새 카테고리 콘텐츠 컨테이너 생성
                    categoryContainer = document.createElement('div');
                    categoryContainer.id = category;
                    categoryContainer.className = 'menu-grid category-content';
                    
                    // 메인 컨테이너에 추가
                    mainContainer.appendChild(categoryContainer);
                    console.log(`새 카테고리 컨테이너 생성: ${category}`);
                }
                
                // 메뉴 아이템이 있으면 기존 내용 지우고 새로운 메뉴로 교체
                if (menuData[category] && menuData[category].length > 0) {
                    categoryContainer.innerHTML = '';
                    
                    menuData[category].forEach(item => {
                        // 이미지 URL 안전성 검증
                        let safeImageUrl = 'https://images.unsplash.com/photo-1551024506-0bccd828d307';
                        
                        if (item.imageUrl) {
                            // 구글 드라이브 URL 변환 시도
                            if (item.imageUrl.includes('drive.google.com/file/d/')) {
                                const convertedUrl = convertGoogleDriveUrl(item.imageUrl);
                                if (convertedUrl) {
                                    console.log('메뉴 렌더링 중 구글 드라이브 URL 변환:', item.imageUrl, ' -> ', convertedUrl);
                                    item.imageUrl = convertedUrl;
                                }
                            }
                            
                            try {
                                // URL이 올바른 형식인지 확인
                                new URL(item.imageUrl);
                                safeImageUrl = item.imageUrl;
                            } catch (e) {
                                console.warn('메뉴 렌더링 중 유효하지 않은 URL:', item.imageUrl);
                            }
                        }
                        
                        // 비건/논비건 표시 결정
                        // 메뉴 이름이나 설명에 고기, 고깃살, 육, 쇠고기, chicken, beef, pork, meat 등이 포함되어 있으면 논비건으로 표시
                        const isNonVeg = (item.name.toLowerCase().includes('chicken') || 
                                        item.name.toLowerCase().includes('beef') || 
                                        item.name.toLowerCase().includes('pork') || 
                                        item.name.toLowerCase().includes('meat') ||
                                        (item.description && (
                                            item.description.toLowerCase().includes('chicken') || 
                                            item.description.toLowerCase().includes('beef') || 
                                            item.description.toLowerCase().includes('pork') ||
                                            item.description.toLowerCase().includes('meat')
                                        )));
                        
                        console.log(`메뉴 아이템 렌더링: ${item.name}, 이미지 URL: ${safeImageUrl}`);
                        
                        const menuItemHtml = `
                            <div class="menu-item">
                                ${isNonVeg ? '<div class="veg-indicator"></div>' : ''}
                                <div class="menu-item-header">
                                    <img src="${safeImageUrl}" 
                                         alt="${item.name}" 
                                         onerror="
                                         const fileIdMatch = this.getAttribute('data-original-src').match(/\\/d\\/([^/]+)|\\/id=([^&]+)/);
                                         const fileId = fileIdMatch ? (fileIdMatch[1] || fileIdMatch[2]) : null;
                                         if (fileId) {
                                             console.log('이미지 로드 실패, 대체 방법 시도:', fileId);
                                             tryAlternativeImageUrl(this, fileId);
                                         } else {
                                             this.onerror=null; 
                                             this.src='https://images.unsplash.com/photo-1551024506-0bccd828d307';
                                             console.error('이미지 로드 실패, 기본 이미지 사용:', this.getAttribute('data-original-src'));
                                         }"
                                         data-original-src="${safeImageUrl}"
                                         loading="lazy"
                                         crossorigin="anonymous">
                                    <div class="menu-item-content">
                                        <h3>${item.name}</h3>
                                        <p>${item.description || '설명 없음'}</p>
                                    </div>
                                </div>
                                <div class="price-container">
                                    <div class="price">$ ${Number(item.price).toLocaleString()} USD</div>
                                    <button class="add-to-cart" onclick="addToCart('${item.name}', ${item.price})">
                                        <span>Add</span>
                                    </button>
                                </div>
                            </div>
                        `;
                        categoryContainer.innerHTML += menuItemHtml;
                    });
                } else {
                    // 메뉴가 없는 경우 메시지 표시
                    categoryContainer.innerHTML = '<div class="no-items-message">No items available in this category</div>';
                }
            });
        }

        // 카테고리 탭 업데이트 함수
        function updateCategoryTabs(categories) {
            // 기존 탭 컨테이너 찾기
            const tabsContainer = document.querySelector('.category-tabs');
            if (!tabsContainer) return;
            
            // 현재 활성화된 탭 찾기
            let activeTabCategory = document.querySelector('.category-tab.active')?.getAttribute('data-category') || 'donut';
            
            // 처음 페이지 로드 시 'donut' 카테고리 기본 선택
            // 만약 'donut' 카테고리가 없으면 첫 번째 카테고리 선택
            if (!categories.includes(activeTabCategory)) {
                activeTabCategory = categories.includes('donut') ? 'donut' : categories[0];
            }
            
            // 기존 탭 모두 제거
            tabsContainer.innerHTML = '';
            
            // 새 탭 추가
            categories.forEach(category => {
                const tabBtn = document.createElement('button');
                tabBtn.className = 'category-tab';
                tabBtn.setAttribute('data-category', category);
                
                // 사용자에게 보여질 이름 (첫 글자만 대문자로)
                const displayName = category.charAt(0).toUpperCase() + category.slice(1);
                tabBtn.textContent = displayName;
                
                // 활성 탭 설정
                if (category === activeTabCategory) {
                    tabBtn.classList.add('active');
                }
                
                // 클릭 이벤트 리스너
                tabBtn.addEventListener('click', function() {
                    // 모든 탭에서 active 클래스 제거
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    
                    // 클릭한 탭에 active 클래스 추가
                    this.classList.add('active');
                    
                    // 모든 콘텐츠에서 active 클래스 제거 (모든 메뉴 숨김)
                    document.querySelectorAll('.category-content').forEach(content => content.classList.remove('active'));
                    
                    // 클릭한 탭에 해당하는 콘텐츠에만 active 클래스 추가 (해당 메뉴만 표시)
                    const categoryId = this.getAttribute('data-category');
                    document.getElementById(categoryId).classList.add('active');
                });
                
                tabsContainer.appendChild(tabBtn);
            });
            
            // 카테고리 콘텐츠 업데이트
            updateCategoryVisibility(activeTabCategory);
        }
        
        // 카테고리 표시 상태 업데이트
        function updateCategoryVisibility(activeCategory) {
            // 모든 카테고리 콘텐츠 숨기기
            document.querySelectorAll('.category-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 활성화된 카테고리만 표시
            const activeContent = document.getElementById(activeCategory);
            if (activeContent) {
                activeContent.classList.add('active');
            } else {
                // 활성화된 카테고리가 없으면 첫 번째 카테고리 활성화
                const firstContent = document.querySelector('.category-content');
                if (firstContent) {
                    firstContent.classList.add('active');
                }
            }
        }

        // DOM이 완전히 로드된 후 실행
        document.addEventListener('DOMContentLoaded', async function() {
            // 초기 로딩 표시
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.querySelector('.loading-content p').textContent = '메뉴 불러오는 중...';
            
            // 페이지 깜박임 방지를 위해 초기 카테고리 구조 생성
            const mainContainer = document.querySelector('.container');
            const initialCategories = ['donut', 'cake-donut', 'breakfast'];
            
            initialCategories.forEach(category => {
                if (!document.getElementById(category)) {
                    const categoryContainer = document.createElement('div');
                    categoryContainer.id = category;
                    categoryContainer.className = 'menu-grid category-content';
                    
                    if (category === 'donut') {
                        categoryContainer.classList.add('active');
                    }
                    
                    mainContainer.appendChild(categoryContainer);
                }
            });
            
            // 초기 메뉴 로드
            await refreshMenu();
            
            // 주기적으로 메뉴 업데이트
            setInterval(refreshMenu, REFRESH_INTERVAL);
            
            // 이미지 로드 상태 모니터링
            setTimeout(() => {
                const allImages = document.querySelectorAll('.menu-item img');
                console.log(`총 ${allImages.length}개 이미지 로드 상태 확인 중...`);
                
                allImages.forEach((img, index) => {
                    if (!img.complete || img.naturalHeight === 0) {
                        console.warn(`이미지 ${index+1} 로드 실패:`, img.src);
                        
                        // 구글 드라이브 이미지 자동 재시도
                        const fileIdMatch = img.getAttribute('data-original-src')?.match(/\/d\/([^/]+)|\/id=([^&]+)/);
                        const fileId = fileIdMatch ? (fileIdMatch[1] || fileIdMatch[2]) : null;
                        
                        if (fileId) {
                            console.log('이미지 자동 재시도:', fileId);
                            
                            // 첫 번째 대체 방법 시도
                            img.src = `https://drive.google.com/uc?export=view&id=${fileId}`;
                            
                            // 두 번째 대체 방법도 실패하면 썸네일 시도
                            img.onerror = function() {
                                this.onerror = null;
                                this.src = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
                                
                                // 마지막 실패 시 기본 이미지
                                this.onerror = function() {
                                    this.onerror = null;
                                    this.src = 'https://images.unsplash.com/photo-1551024506-0bccd828d307';
                                };
                            };
                        }
                    }
                });
            }, 3000); // 3초 후 이미지 상태 확인
        });

        // 장바구니 토글
        function toggleCart() {
            const cartModal = document.getElementById('cartModal');
            cartModal.classList.toggle('show');
            if (cartModal.classList.contains('show')) {
                updateCartDisplay();
            }
        }

        // 장바구니에 아이템 추가
        function addToCart(name, price) {
            const existingItem = cart.find(item => item.name === name);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ name, price, quantity: 1 });
            }
            updateCartCount();
            updateCartDisplay();
            
            // 추가 성공 시각적 피드백
            // 1. 장바구니 아이콘 애니메이션
            const cartIcon = document.querySelector('.cart-icon');
            cartIcon.classList.add('add-success');
            setTimeout(() => {
                cartIcon.classList.remove('add-success');
            }, 500);
            
            // 2. 해당 버튼에 성공 피드백
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                const itemName = item.querySelector('h3').textContent;
                if (itemName === name) {
                    const addButton = item.querySelector('.add-to-cart');
                    const originalText = addButton.textContent;
                    addButton.textContent = 'Added';
                    addButton.style.backgroundColor = '#4CAF50';
                    
                    setTimeout(() => {
                        addButton.textContent = originalText;
                        addButton.style.backgroundColor = '';
                    }, 1000);
                }
            });
        }

        // 장바구니 카운트 업데이트
        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = totalItems;
        }

        // 장바구니 표시 업데이트
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            cartItems.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                cartItems.innerHTML = `
                    <div class="empty-cart-message">
                        <i class="material-icons">shopping_cart</i>
                        <p>Your cart is empty</p>
                    </div>
                `;
                cartTotal.textContent = '0';
                return;
            }

            cart.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;

                cartItems.innerHTML += `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">$${item.price.toLocaleString()} × ${item.quantity}</div>
                        </div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn" onclick="updateQuantity(${index}, -1)"><i class="material-icons">remove</i></button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn" onclick="updateQuantity(${index}, 1)"><i class="material-icons">add</i></button>
                            <button class="quantity-btn" onclick="removeFromCart(${index})"><i class="material-icons">delete</i></button>
                        </div>
                    </div>
                `;
            });

            cartTotal.textContent = total.toLocaleString();
        }

        // 수량 업데이트
        function updateQuantity(index, change) {
            cart[index].quantity += change;
            if (cart[index].quantity <= 0) {
                cart.splice(index, 1);
            }
            updateCartCount();
            updateCartDisplay();
        }

        // 장바구니에서 아이템 완전히 제거
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartCount();
            updateCartDisplay();
        }

        // 주문 폼 표시
        function showOrderForm() {
            if (cart.length === 0) {
                alert('장바구니가 비어있습니다.');
                return;
            }
            document.getElementById('orderModal').classList.add('show');
        }

        // 주문 폼 닫기
        function closeOrderForm() {
            document.getElementById('orderModal').classList.remove('show');
        }

        // 주문 제출
        function submitOrder(event) {
            event.preventDefault();

            // 필수 입력값 검증
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const deliveryOption = document.getElementById('deliveryOption').value;
            const pickupTime = document.getElementById('pickupTime').value;

            if (!name || !phone) {
                alert('이름과 전화번호는 필수 입력 항목입니다.');
                return;
            }

            if (deliveryOption === 'delivery' && !address) {
                alert('배달 주문의 경우 주소를 입력해주세요.');
                return;
            }

            if (!pickupTime) {
                alert('픽업 시간을 선택해주세요.');
                return;
            }

            // 장바구니 아이템을 문자열로 변환
            const itemDetails = cart.map(item => 
                `${item.name} (${item.price}원 x ${item.quantity}개)`
            ).join('\n');

            // 총 주문 금액 계산
            const totalAmount = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            const orderData = {
                name: name,
                phone: phone,
                address: address,
                deliveryOption: deliveryOption,
                pickupTime: pickupTime,
                items: cart.map(item => ({
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                itemDetails: itemDetails,
                total: totalAmount
            };

            // 로딩 표시
            document.getElementById('loadingOverlay').style.display = 'flex';

            // 구글 시트에 데이터 전송
            fetch('https://script.google.com/macros/s/AKfycbzuIZT-pRiC4o53u0ruWefsfRqyDasNQqW7nOfs5ipHZ0PlicbFP3FixcjDZv4rha8QXQ/exec', {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(orderData),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(() => {
                // no-cors 모드에서는 응답을 받을 수 없으므로 바로 성공 처리
                alert('주문이 완료되었습니다! 감사합니다.');
                cart = [];
                updateCartCount();
                closeOrderForm();
                toggleCart();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('주문이 처리되었습니다. 감사합니다.');
                cart = [];
                updateCartCount();
                closeOrderForm();
                toggleCart();
            })
            .finally(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        // JSONP로 데이터 가져오기
        function fetchMenuDataJSONP() {
            return new Promise((resolve, reject) => {
                // 콜백 함수 이름 생성
                const callbackName = 'jsonpCallback_' + Math.round(Math.random() * 10000);
                
                // 타임아웃 설정 (5초)
                const timeoutId = setTimeout(() => {
                    reject(new Error('JSONP 요청 타임아웃'));
                    cleanup();
                }, 5000);
                
                function cleanup() {
                    // 스크립트 태그가 있으면 제거
                    if (script && script.parentNode) {
                        document.body.removeChild(script);
                    }
                    // 글로벌 콜백 함수 삭제
                    delete window[callbackName];
                    // 타임아웃 제거
                    clearTimeout(timeoutId);
                }
                
                // 글로벌 스코프에 콜백 함수 정의
                window[callbackName] = function(data) {
                    cleanup();
                    // 데이터 반환
                    resolve(data);
                };
                
                // 스크립트 태그 생성
                const script = document.createElement('script');
                script.src = `${API_URL}?action=getMenu&callback=${callbackName}`;
                
                // 에러 처리
                script.onerror = function() {
                    cleanup();
                    // reject 대신 정보 메시지를 콘솔에 기록하고 특별한 값으로 resolve
                    console.info('JSONP 요청을 사용할 수 없습니다. 대체 방법으로 전환합니다.');
                    resolve({ _jsonpError: true });
                };
                
                // 스크립트 태그를 body에 추가하면 자동으로 로드됨
                document.body.appendChild(script);
            });
        }
        
        // 직접 이미지 URL에 접근하여 메뉴 데이터 구성하기
        async function fetchDirectImageUrls() {
            try {
                // 카테고리 이름과 메뉴 이름도 함께 가져오기
                const menuResponse = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=메뉴 목록`);
                const menuCsvText = await menuResponse.text();
                
                // CSV 파싱을 간소화하면서 큰따옴표 처리에 주의
                const rows = menuCsvText.split('\n');
                const menuLines = [];
                
                for (let row of rows) {
                    // 빈 줄 무시
                    if (!row.trim()) continue;
                    
                    const fields = [];
                    let inQuote = false;
                    let field = '';
                    
                    for (let i = 0; i < row.length; i++) {
                        const char = row[i];
                        
                        if (char === '"') {
                            inQuote = !inQuote;
                        } else if (char === ',' && !inQuote) {
                            fields.push(field.replace(/^"|"$/g, ''));
                            field = '';
                        } else {
                            field += char;
                        }
                    }
                    
                    fields.push(field.replace(/^"|"$/g, ''));
                    menuLines.push(fields);
                }
                
                // 헤더 행 처리
                const headers = menuLines[0].map(header => header.toLowerCase().trim());
                
                const categoryIndex = headers.indexOf('category');
                const nameIndex = headers.indexOf('name');
                const descriptionIndex = headers.indexOf('description');
                const priceIndex = headers.indexOf('price');
                const imageUrlIndex = headers.indexOf('imageurl');
                
                if (categoryIndex === -1 || nameIndex === -1 || priceIndex === -1) {
                    throw new Error('필수 열(category, name, price)이 없습니다.');
                }
                
                // 카테고리 구조 생성
                const menuData = {};
                const categories = new Set();
                
                // 카테고리 수집
                for (let i = 1; i < menuLines.length; i++) {
                    const row = menuLines[i];
                    if (row.length <= categoryIndex) continue;
                    
                    const category = row[categoryIndex]?.trim();
                    if (category) {
                        categories.add(category);
                    }
                }
                
                // 카테고리별 빈 배열 생성
                categories.forEach(category => {
                    menuData[category] = [];
                });
                
                // 기본 메뉴 데이터 구성
                for (let i = 1; i < menuLines.length; i++) {
                    const row = menuLines[i];
                    if (row.length <= categoryIndex) continue;
                    
                    const category = row[categoryIndex]?.trim();
                    const name = row[nameIndex]?.trim();
                    const price = parseFloat(row[priceIndex]);
                    
                    if (!category || !name || isNaN(price)) continue;
                    
                    const menuItem = {
                        name: name,
                        price: price,
                        description: descriptionIndex !== -1 && row.length > descriptionIndex ? row[descriptionIndex]?.trim() || '' : '',
                        imageUrl: 'https://images.unsplash.com/photo-1551024506-0bccd828d307' // 기본 이미지로 초기화
                    };
                    
                    if (menuData[category]) {
                        menuData[category].push(menuItem);
                    }
                }
                
                // 이제 이미지 URL 업데이트
                if (imageUrlIndex !== -1) {
                    for (let i = 1; i < menuLines.length; i++) {
                        const row = menuLines[i];
                        if (row.length <= imageUrlIndex) continue;
                        
                        const category = row[categoryIndex]?.trim();
                        const name = row[nameIndex]?.trim();
                        const imageUrl = row[imageUrlIndex]?.trim();
                        
                        if (!category || !name || !imageUrl) continue;
                        
                        // 해당 메뉴 아이템 찾기
                        const categoryItems = menuData[category];
                        if (categoryItems) {
                            const menuItem = categoryItems.find(item => item.name === name);
                            if (menuItem) {
                                // 구글 드라이브 URL 변환 시도
                                if (imageUrl.includes('drive.google.com/file/d/')) {
                                    const convertedUrl = convertGoogleDriveUrl(imageUrl);
                                    if (convertedUrl) {
                                        console.log('직접 URL 접근: 구글 드라이브 URL 변환:', imageUrl, ' -> ', convertedUrl);
                                        menuItem.imageUrl = convertedUrl;
                                    } else {
                                        menuItem.imageUrl = imageUrl;
                                    }
                                } else {
                                    menuItem.imageUrl = imageUrl;
                                }
                            }
                        }
                    }
                }
                
                console.log('직접 접근으로 생성된 메뉴 데이터:', Object.keys(menuData));
                return menuData;
            } catch (error) {
                console.error('직접 이미지 URL 가져오기 실패:', error);
                return null;
            }
        }

        // 구글 드라이브 URL을 직접 이미지 URL로 변환
        function convertGoogleDriveUrl(driveUrl) {
            try {
                // 구글 드라이브 URL 패턴 확인
                if (!driveUrl || typeof driveUrl !== 'string') return null;
                
                // 파일 ID 추출 패턴: https://drive.google.com/file/d/FILE_ID/view
                const fileIdMatch = driveUrl.match(/\/file\/d\/([^\/]+)/);
                if (!fileIdMatch || !fileIdMatch[1]) return null;
                
                const fileId = fileIdMatch[1];
                console.log('변환된 구글 드라이브 파일 ID:', fileId);
                
                // 여러 방법을 시도하고, 이미지 로드 실패 시 다른 방법 사용
                
                // 방법 1: googleusercontent 직접 링크 형식
                return `https://lh3.googleusercontent.com/d/${fileId}`;
                
                // 방법 2: 공개 권한 있는 파일용 uc 링크
                // return `https://drive.google.com/uc?export=view&id=${fileId}`;
                
                // 방법 3: 구글 드라이브 썸네일 API (작은 이미지)
                // return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
                
                // 방법 4: 구글 드라이브 미리보기 (iframe 안에서만 작동)
                // return `https://drive.google.com/file/d/${fileId}/preview`;
            } catch (error) {
                console.error('구글 드라이브 URL 변환 실패:', error);
                return null;
            }
        }
        
        // 실패한 이미지를 다른 방식으로 로드 시도하는 함수
        function tryAlternativeImageUrl(img, fileId) {
            // 이미 기본 이미지로 대체되었으면 더 이상 시도하지 않음
            if (img.src.includes('unsplash.com')) return;
            
            // 방법 2 시도
            if (!img.src.includes('uc?export=view')) {
                img.src = `https://drive.google.com/uc?export=view&id=${fileId}`;
                return;
            }
            
            // 방법 3 시도
            if (!img.src.includes('thumbnail')) {
                img.src = `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
                return;
            }
            
            // 모든 방법 실패 시 기본 이미지
            img.src = 'https://images.unsplash.com/photo-1551024506-0bccd828d307';
        }
    </script>
</body>
</html> 